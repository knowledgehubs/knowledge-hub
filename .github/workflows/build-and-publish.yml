name: ğŸ—ï¸ Build Hugo and Publish to GitHub Pages (Unified)

on:
  schedule:
    # Schedule the job to run once daily (00:00 UTC)
    - cron: '0 0 * * *'
  
  workflow_dispatch:
    # Allows manual trigger and setting the mode
    inputs:
      mode:
        description: 'SYSTEM_MODE: LIVE or TEST'
        required: true
        default: 'TEST'
        type: choice
        options:
          - LIVE
          - TEST
          
jobs:
  build:
    runs-on: ubuntu-latest
    
    # ğŸ’¡ Ø¥Ø°Ù† Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø¶Ø±ÙˆØ±ÙŠ Ù„Ø®Ø·ÙˆØ© git push Ø§Ù„Ù„Ø§Ø­Ù‚Ø©
    permissions:
      contents: write
      
    env:
      SYSTEM_MODE: ${{ github.event.inputs.mode || 'LIVE' }} 
      
    steps:
      - name: â¬‡ï¸ Checkout Repository (Full History & Submodules)
        # Token Ø¶Ø±ÙˆØ±ÙŠ Ù„Ø¬Ù„Ø¨ Ø§Ù„Ù€ Submodules ÙˆØ¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù€ Push
        uses: actions/checkout@v4
        with:
          submodules: true # ğŸ’¡ Ù‡Ø°Ø§ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¢Ù† Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ÙŠØ¯ÙˆÙŠ
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }} 

      # âŒ ØªÙ… Ø­Ø°Ù Ø®Ø·ÙˆØ© "Ensure Ananke Theme is Available" Ù„ØªØ¬Ù†Ø¨ Ø®Ø·Ø£ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©

      - name: ğŸ—ï¸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: âš™ï¸ Set Git User for Commit
        run: |
          git config --global user.email "knowledgehub-bot@users.noreply.github.com"
          git config --global user.name "Knowledge Hub Automation Bot"

      - name: ğŸš€ Run Generator Script
        run: python content-engine/generator.py
        env:
          SYSTEM_MODE: ${{ env.SYSTEM_MODE }}
          
      - name: â¬†ï¸ Push Content Commit (If New Content Generated)
        if: env.SYSTEM_MODE == 'LIVE'
        run: |
          git push

      - name: ğŸ› ï¸ Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: 'latest'

      - name: âš™ï¸ Build Hugo Site
        # Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø·ÙˆØ© ÙŠØ¬Ø¨ Ø£Ù† ØªØ¹Ù…Ù„ Ø§Ù„Ø¢Ù† Ø¨Ø¹Ø¯ Ø£Ù† Ø¬Ù„Ø¨Øª Ø®Ø·ÙˆØ© Ø§Ù„Ù€ Checkout Ø§Ù„Ù‚Ø§Ù„Ø¨
        run: hugo --minify

      - name: ğŸš€ Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        if: success() 
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          publish_branch: gh-pages
          cname: ''
