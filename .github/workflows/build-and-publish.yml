name: ğŸ—ï¸ Build Hugo and Publish to GitHub Pages (Unified)

on:
  schedule:
    # Schedule the job to run once daily (00:00 UTC)
    - cron: '0 0 * * *'
  
  workflow_dispatch:
    # Allows manual trigger and setting the mode
    inputs:
      mode:
        description: 'SYSTEM_MODE: LIVE or TEST'
        required: true
        default: 'TEST'
        type: choice
        options:
          - LIVE
          - TEST
          
jobs:
  build:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      
    env:
      SYSTEM_MODE: ${{ github.event.inputs.mode || 'LIVE' }} 
      
    steps:
      - name: â¬‡ï¸ Checkout Repository (Full History)
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }} 

      - name: ğŸ“¥ Ensure Ananke Theme is Available
        run: |
          # ğŸ’¡ Ø§Ù„ØªØµØ­ÙŠØ­ Ù‡Ù†Ø§: Ø§Ø³ØªØ®Ø¯Ø§Ù… GITHUB_TOKEN Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ GitHub
          if [ ! -d "themes/ananke" ]; then
            git clone https://${{ secrets.GITHUB_TOKEN }}@github.com/theNewDynamic/Ananke themes/ananke
          fi

      - name: ğŸ—ï¸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: âš™ï¸ Set Git User for Commit
        run: |
          git config --global user.email "knowledgehub-bot@users.noreply.github.com"
          git config --global user.name "Knowledge Hub Automation Bot"

      - name: ğŸš€ Run Generator Script
        run: python content-engine/generator.py
        env:
          SYSTEM_MODE: ${{ env.SYSTEM_MODE }}
          
      - name: â¬†ï¸ Push Content Commit (If New Content Generated)
        if: env.SYSTEM_MODE == 'LIVE'
        run: |
          git push

      - name: ğŸ› ï¸ Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: 'latest'

      - name: âš™ï¸ Build Hugo Site
        run: hugo --minify

      - name: ğŸš€ Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        if: success() 
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          publish_branch: gh-pages
          cname: ''
